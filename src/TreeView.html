<div class="TreeView" on:click="chkEvent(event)">
	<LineNode line={rawTree} bind:layersTree bind:gmxTimeline />
</div>
 

<style>
.TreeView {
    position: absolute;
	width: 100%;
    overflow-y: scroll;
	background-color: white;
}
</style>

<script>
	import LineNode from './LineNode.html';
	let regs = {
		cmd: /cmd:(\w+)/,
		id: /id:(\w+)/
	}
	export default {
		data() {
			return {
				config: {},
				layersTree: {
					visible: {},
					expanded: {}
				},
				//gmxTimeline: false,
				group: null,
				rawTree: null
			}
		},

		methods: {
			chkEvent(ev) {
				let target = ev.target,
					className = target.className,
					arr = regs.cmd.exec(className);

				if (arr && arr.length === 2) {
					let out = {
						cmd: arr[1],
						type: ev.type,
						originalEvent: ev
					};
					for(let i = 0; i < 10; i++) {
						if (target.classList.contains('line')) {
							arr = regs.id.exec(target.className);
							if (arr && arr.length === 2) {
								out.id = arr[1];
							}
							out.target = target;
							break;
						}
						target = target.parentNode;
					}
					if (out.id) {
						this.treeCommands(out);
						this.fire('command', out);
					}
				}
			},

			treeCommands(attr) {
				let {layersTree, rawTree} = this.get();
//console.log('treeCommands', attr);

				if (attr.cmd === 'clickOnExpander') {
					layersTree.expanded[attr.id] = !layersTree.expanded[attr.id];
					this.set({layersTree: layersTree});
				} else if (attr.cmd === 'toggleGroup') {
					let inputs = attr.target.getElementsByClassName('visibility'),
						isExpanded = !layersTree.visible[attr.id];

					layersTree.expanded[attr.id] = isExpanded;
					layersTree.visible[attr.id] = isExpanded;

					for(let i = 0, len = inputs.length; i < len; i++) {
						let it = inputs[i],
							arr = regs.id.exec(it.className),
							pid = arr && arr.length === 2 ? arr[1] : '';
						if (it.classList.contains('group')) {
							layersTree.expanded[pid] = isExpanded;
							layersTree.visible[pid] = isExpanded;
						} else {
							this.fire('command', {
								cmd: 'toggleNode',
								type: attr.type,
								target: it,
								set: isExpanded,
								id: pid,
								originalEvent: attr.originalEvent
							});
							layersTree.visible[pid] = isExpanded;
						}
					}

					this.set({layersTree: layersTree});
				} else if (attr.cmd === 'toggleVisibility') {
					let isGroup = attr.target.getElementsByClassName('expanderInput')[0],
						target = attr.originalEvent.target,
						expanded = isGroup ? layersTree.expanded : layersTree.visible,
						id = attr.id;
					if (expanded[id]) {			// TODO: layersTree для пермалинков
						delete expanded[id];
					} else {
						expanded[id] = true;
					}
					this.set({layersTree: layersTree});
					return true;
				}
				return false;
			},

			appendNode(id) {
				this.options.appendNode(id);
			}
		},
		components: {
			LineNode
		}
	}

</script>
